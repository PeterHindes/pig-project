<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pig Game Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .game-setup {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .game-board {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
        }

        .game-board.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .player-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 20px;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .player-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .player-card.current-user {
            border-color: #48bb78;
        }

        .player-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .player-score {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .player-status {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .game-info {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }

        .game-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .dice-display {
            text-align: center;
            margin: 30px 0;
        }

        .dice {
            display: inline-block;
            width: 100px;
            height: 100px;
            background: white;
            border: 3px solid #333;
            border-radius: 15px;
            font-size: 4em;
            line-height: 100px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: rollAnimation 0.5s ease-in-out;
        }

        @keyframes rollAnimation {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg) scale(1.1); }
            75% { transform: rotate(10deg) scale(1.1); }
        }

        .log {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-title {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #333;
        }

        .log-entry {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            font-size: 0.9em;
        }

        .log-entry.error {
            border-left-color: #f56565;
            background: #fff5f5;
        }

        .log-entry.success {
            border-left-color: #48bb78;
            background: #f0fff4;
        }

        .connection-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .connection-status.connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .connection-status.disconnected {
            background: #fed7d7;
            color: #742a2a;
        }

        .winner-banner {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border: 3px solid #f39c12;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            animation: winnerPulse 1s ease-in-out infinite;
        }

        .winner-banner h2 {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 10px;
        }

        @keyframes winnerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .api-config {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .api-config label {
            font-size: 0.9em;
        }

        .api-config input {
            font-size: 14px;
            padding: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≤ Pig Dice Game üé≤</h1>

        <!-- Game Setup -->
        <div class="game-setup" id="setupSection">
            <h2 style="margin-bottom: 20px; color: #667eea;">Join or Create Game</h2>

            <div class="api-config">
                <div class="input-group">
                    <label for="apiUrl">API Server URL:</label>
                    <input type="text" id="apiUrl" value="http://localhost:8080" placeholder="http://localhost:8080">
                </div>
            </div>

            <div class="input-group">
                <label for="playerName">Your Name:</label>
                <input type="text" id="playerName" placeholder="Enter your name" value="Player1">
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="createMatch()">Create New Game</button>
                <button class="btn-success" onclick="joinMatch()">Join Available Game</button>
            </div>
        </div>

        <!-- Game Board -->
        <div class="game-board" id="gameBoard">
            <div class="connection-status disconnected" id="connectionStatus">Disconnected</div>

            <div id="winnerBanner"></div>

            <div class="game-info">
                <div class="game-info-grid">
                    <div class="info-item">
                        <div class="info-label">Turn Score</div>
                        <div class="info-value" id="turnScore">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Last Roll</div>
                        <div class="info-value" id="lastRoll">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Target</div>
                        <div class="info-value" id="targetScore">100</div>
                    </div>
                </div>
            </div>

            <div class="dice-display" id="diceDisplay" style="display: none;">
                <div class="dice" id="diceValue">üé≤</div>
            </div>

            <div class="players-grid" id="playersGrid"></div>

            <div class="button-group">
                <button class="btn-success" id="rollBtn" onclick="roll()" disabled>üé≤ Roll Dice</button>
                <button class="btn-warning" id="holdBtn" onclick="hold()" disabled>üí∞ Hold & Bank</button>
                <button class="btn-danger" onclick="disconnect()">Disconnect</button>
            </div>

            <div class="log">
                <div class="log-title">Game Log</div>
                <div id="gameLog"></div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let gameState = null;
        let playerId = null;
        let playerName = null;
        let gameId = null;

        function getApiUrl() {
            return document.getElementById('apiUrl').value;
        }

        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('gameLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);

            // Keep only last 50 entries
            while (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        async function createMatch() {
            playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Please enter your name');
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/api/match/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_name: playerName })
                });

                const data = await response.json();
                playerId = data.player_id;
                gameId = data.game_id;

                addLog(`Created game ${gameId}`, 'success');
                connectWebSocket(data.ws_url);
            } catch (error) {
                addLog(`Error creating match: ${error.message}`, 'error');
                alert('Failed to create match. Is the server running?');
            }
        }

        async function joinMatch() {
            playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Please enter your name');
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/api/match/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_name: playerName })
                });

                const data = await response.json();
                playerId = data.player_id;
                gameId = data.game_id;

                addLog(`Joined game ${gameId}`, 'success');
                connectWebSocket(data.ws_url);
            } catch (error) {
                addLog(`Error joining match: ${error.message}`, 'error');
                alert('Failed to join match. Is the server running?');
            }
        }

        function connectWebSocket(wsUrl) {
            // Convert http to ws in URL if needed
            wsUrl = wsUrl.replace('http://', 'ws://').replace('https://', 'wss://');

            addLog(`Connecting to ${wsUrl}...`);
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                addLog('Connected to game server', 'success');
                updateConnectionStatus(true);
                document.getElementById('setupSection').style.display = 'none';
                document.getElementById('gameBoard').classList.add('active');
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleMessage(message);
            };

            ws.onerror = (error) => {
                addLog('WebSocket error occurred', 'error');
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                addLog('Disconnected from game server', 'error');
                updateConnectionStatus(false);
                disableGameControls();
            };
        }

        function handleMessage(message) {
            console.log('Received message:', message);

            switch (message.type) {
                case 'joined':
                    addLog('Successfully joined the game', 'success');
                    gameState = message.game_state;
                    updateGameBoard();
                    break;

                case 'game_start':
                    addLog('Game has started! Let\'s play!', 'success');
                    gameState = message.game_state;
                    updateGameBoard();
                    break;

                case 'game_update':
                    if (message.data && message.data.roll) {
                        const roll = message.data.roll;
                        showDiceRoll(roll);
                        if (roll === 1) {
                            addLog('Rolled a 1! Turn lost!', 'error');
                        } else {
                            addLog(`Rolled a ${roll}!`, 'success');
                        }
                    } else if (message.data && message.data.action === 'hold') {
                        addLog('Player held and banked their points', 'info');
                    }
                    gameState = message.game_state;
                    updateGameBoard();
                    break;

                case 'game_over':
                    gameState = message.game_state;
                    updateGameBoard();
                    const winner = gameState.winner;
                    addLog(`Game Over! ${winner.name} wins with ${winner.score} points!`, 'success');
                    showWinner(winner);
                    disableGameControls();
                    break;

                case 'player_left':
                    addLog('A player has left the game', 'info');
                    gameState = message.game_state;
                    updateGameBoard();
                    break;

                case 'error':
                    addLog(`Error: ${message.error}`, 'error');
                    break;
            }
        }

        function updateGameBoard() {
            if (!gameState) return;

            // Update game info
            document.getElementById('turnScore').textContent = gameState.turn_score;
            document.getElementById('lastRoll').textContent = gameState.last_roll || '-';
            document.getElementById('targetScore').textContent = gameState.winning_score;

            // Update players
            const playersGrid = document.getElementById('playersGrid');
            playersGrid.innerHTML = '';

            gameState.players.forEach((player, index) => {
                const card = document.createElement('div');
                card.className = 'player-card';

                if (index === gameState.current_player && player.is_active) {
                    card.classList.add('active');
                }

                if (player.id === playerId) {
                    card.classList.add('current-user');
                }

                let statusText = player.is_active ? '‚úì Active' : '‚úó Inactive';
                if (index === gameState.current_player && player.is_active) {
                    statusText = '‚ñ∂Ô∏è Current Turn';
                }

                card.innerHTML = `
                    <div class="player-name">${player.name} ${player.id === playerId ? '(You)' : ''}</div>
                    <div class="player-score">${player.score} pts</div>
                    <div class="player-status">${statusText}</div>
                `;

                playersGrid.appendChild(card);
            });

            // Enable/disable controls based on turn
            updateGameControls();
        }

        function updateGameControls() {
            if (!gameState || gameState.is_game_over) {
                disableGameControls();
                return;
            }

            const currentPlayer = gameState.players[gameState.current_player];
            const isMyTurn = currentPlayer && currentPlayer.id === playerId;

            document.getElementById('rollBtn').disabled = !isMyTurn;
            document.getElementById('holdBtn').disabled = !isMyTurn || gameState.turn_score === 0;
        }

        function disableGameControls() {
            document.getElementById('rollBtn').disabled = true;
            document.getElementById('holdBtn').disabled = true;
        }

        function showDiceRoll(value) {
            const diceDisplay = document.getElementById('diceDisplay');
            const diceValue = document.getElementById('diceValue');

            const diceEmojis = ['', '‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
            diceValue.textContent = diceEmojis[value] || value;

            diceDisplay.style.display = 'block';

            // Trigger animation
            diceValue.style.animation = 'none';
            setTimeout(() => {
                diceValue.style.animation = 'rollAnimation 0.5s ease-in-out';
            }, 10);
        }

        function showWinner(winner) {
            const banner = document.getElementById('winnerBanner');
            banner.className = 'winner-banner';
            banner.innerHTML = `
                <h2>üèÜ ${winner.name} Wins! üèÜ</h2>
                <p style="font-size: 1.5em; color: #555;">Final Score: ${winner.score} points</p>
            `;
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = 'üü¢ Connected';
                status.className = 'connection-status connected';
            } else {
                status.textContent = 'üî¥ Disconnected';
                status.className = 'connection-status disconnected';
            }
        }

        function roll() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ action: 'roll' }));
                addLog('Rolling the dice...', 'info');
            }
        }

        function hold() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ action: 'hold' }));
                addLog('Holding and banking points...', 'info');
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('gameBoard').classList.remove('active');
            document.getElementById('winnerBanner').innerHTML = '';
            addLog('Disconnected from game', 'info');
        }
    </script>
</body>
</html>
